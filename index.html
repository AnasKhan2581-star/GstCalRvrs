<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Split Taxable Amount and Generate Bill Options</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
        margin: 20px 0;
      }
      th, td {
        border: 1px solid #ddd;
        text-align: center;
        padding: 8px;
      }
      th {
        background-color: #f4f4f4;
      }
      .bold {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Split Taxable Amount and Generate Bill Options</h1>

    <!-- Input Section -->
    <label for="grand-total">Grand Total Amount (₹):</label>
    <input type="number" id="grand-total" /><br /><br />
    <label for="splits">Number of Splits:</label>
    <select id="splits">
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
    </select><br /><br />
    <button onclick="generateBillOptions()">Generate Bill Options</button><br /><br />

    <!-- Result Section -->
    <div id="result"></div>

    <script>
      function generateBillOptions() {
        const grandTotal = parseFloat(document.getElementById("grand-total").value);
        const splits = parseInt(document.getElementById("splits").value);
        const taxRate = 0.05;

        // Calculate Taxable Amount and Tax Amounts
        let taxableAmount = Math.round((grandTotal / (1 + taxRate)) * 100) / 100;
        let taxAmount = Math.round(taxableAmount * taxRate * 100) / 100;
        let halfTaxAmount = Math.round((taxAmount / 2) * 100) / 100;

        // Adjust tax amounts for proper rounding
        halfTaxAmount = halfTaxAmount % 1 >= 0.5 ? Math.ceil(halfTaxAmount) : Math.floor(halfTaxAmount);
        taxAmount = 2 * halfTaxAmount;
        taxableAmount = Math.round((grandTotal - taxAmount) * 100) / 100;

        // Split the taxable amount
        const splitAmounts = calculateSplits(taxableAmount, splits);

        // Display Calculated Splits and Tax Details
        let resultHTML = `
          <h2>Result:</h2>
          <div><span class="bold">Taxable Amount: ₹${taxableAmount.toFixed(2)}</span></div>
          <div><span>5% Tax Amount: ₹${taxAmount.toFixed(2)}</span></div>
          <div><span class="bold">2.5% Tax Amount: ₹${halfTaxAmount.toFixed(2)}</span></div>
          <h3>Split Amounts:</h3>
          <ul>${splitAmounts.map((split) => `<li>₹${split.toFixed(2)}</li>`).join("")}</ul>`;

        // Generate Bill Options for all splits
        const billOptions = generateBillOptionsForSplits(splitAmounts, taxableAmount);

        if (billOptions.length > 0) {
          billOptions.forEach((bill, billIndex) => {
            resultHTML += `<h3>Bill Option ${billIndex + 1}:</h3>`;
            resultHTML += generateBillTable(bill, taxableAmount, halfTaxAmount, grandTotal);
          });
        } else {
          resultHTML += `<h3>No valid combinations found for the splits.</h3>`;
        }

        document.getElementById("result").innerHTML = resultHTML;
      }

      function calculateSplits(amount, splits) {
        const splitAmounts = [];
        let remainingAmount = amount;

        for (let i = 0; i < splits - 1; i++) {
          let split = Math.random() * remainingAmount / 2 + remainingAmount / (splits - i);
          split = Math.round(split * 2) / 2; // Round to the nearest 0.5
          splitAmounts.push(split);
          remainingAmount = Math.round((remainingAmount - split) * 100) / 100;
        }
        splitAmounts.push(remainingAmount); // Add the last remaining amount
        return splitAmounts;
      }

      function generateBillOptionsForSplits(splitAmounts, taxableAmount) {
        const options = [];

        function findCombinations(split, minRate, maxRate, description, hsn, unit) {
          const combinations = [];
          for (let rate = minRate; rate <= maxRate; rate += 0.25) {
            const qty = Math.floor(split / rate);
            const amount = qty * rate;
            if (amount <= split && qty > 0) {
              combinations.push({
                description,
                hsn,
                rate: rate.toFixed(2),
                qty,
                unit,
                amount,
              });
            }
          }
          return combinations;
        }

        // Generate combinations for each split
        splitAmounts.forEach((split) => {
          const sareeCombinations = findCombinations(split, 785, 1485, "Saree", "5407", "pc");
          const fabricCombinations = findCombinations(split, 85, 125, "Fabric", "5408", "mtr");

          const validCombinations = [...sareeCombinations, ...fabricCombinations];
          options.push(validCombinations);
        });

        // Ensure combinations add up to taxable amount
        const validOptions = [];
        const totalCombinations = combineOptions(options);

        totalCombinations.forEach((combination) => {
          const totalAmount = combination.reduce((sum, item) => sum + item.amount, 0);
          if (Math.abs(totalAmount - taxableAmount) < 0.01) {
            validOptions.push(combination);
          }
        });

        return validOptions;
      }

      function combineOptions(options, currentIndex = 0, currentCombination = []) {
        if (currentIndex === options.length) {
          return [currentCombination];
        }

        const combinations = [];
        options[currentIndex].forEach((option) => {
          combinations.push(
            ...combineOptions(options, currentIndex + 1, [...currentCombination, option])
          );
        });

        return combinations;
      }

      function generateBillTable(items, taxableAmount, halfTaxAmount, grandTotal) {
        let tableHTML = `<table>
          <thead>
            <tr>
              <th>Description of Goods</th>
              <th>HSN Code</th>
              <th>Rate</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Split Amount</th>
            </tr>
          </thead>
          <tbody>`;

        items.forEach((item) => {
          tableHTML += `<tr>
            <td>${item.description}</td>
            <td>${item.hsn}</td>
            <td>${item.rate}</td>
            <td>${item.qty}</td>
            <td>${item.unit}</td>
            <td>${item.amount.toFixed(2)}</td>
          </tr>`;
        });

        tableHTML += `
          <tr>
            <td colspan="5" class="bold">Taxable Amount</td>
            <td class="bold">${taxableAmount.toFixed(2)}</td>
          </tr>
          <tr>
            <td colspan="5">2.5% Tax Amount</td>
            <td>${halfTaxAmount.toFixed(2)}</td>
          </tr>
          <tr>
            <td colspan="5">2.5% Tax Amount</td>
            <td>${halfTaxAmount.toFixed(2)}</td>
          </tr>
          <tr>
            <td colspan="5" class="bold">Grand Total</td>
            <td class="bold">${grandTotal.toFixed(2)}</td>
          </tr>
        </tbody>
      </table>`;

        return tableHTML;
      }
    </script>
  </body>
</html>
